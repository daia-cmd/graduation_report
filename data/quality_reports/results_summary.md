# 前処理結果総合分析レポート

**作成日**: 2026年1月29日  
**対象**: 4つのデータレイヤーの前処理結果

---

## 🎯 全体サマリー

| レイヤー | 初期行数 | 最終行数 | 保持率 | 国数 | 状態 |
|---------|---------|---------|--------|------|------|
| **移住** | 28,030 | 38,530 | 137.46% | ~200 | ✅ 良好 |
| **外交** | 433,552 | 43,650 | 10.07% | ~200 | ✅ 良好 |
| **航空** | 67,663路線 | 4,301国ペア | 50.36% | ~200 | ✅ 良好 |
| **貿易** | 1,151,772 | 144,463 | 12.54% | 227 | ✅ 良好 |

**総評**: ✅ すべてのレイヤーが正常に処理され、5年分のデータ（2000, 2005, 2010, 2015, 2020）が生成されました。

---

## 1. 移住データ（Migration）

### 📈 データ品質
```
初期行数: 28,030
最終行数: 38,530 ✓
保持率: 137.46% (Melt処理により増加)
```

### ✅ 良好な点
- **十分なデータ量**: 38,530行（> 30,000行の基準をクリア）
- **地域集計の適切な除外**: 65.9%が地域集計（正常）
- **データカバレッジ**: 5年分すべて揃っている

### ⚠️ 注意点
- **ISO変換失敗率**: 22.0%（40カ国）
  - 主な失敗: Gibraltar, Greenland, Puerto Rico など属領・特殊地域
  - **影響**: 軽微（主要国は変換成功）

### 📊 データ構造
```
year,origin,destination,migrant_stock
2000,AFG,ARE,2588
2000,AFG,AUS,15067
```

**予想される年別データ量**: 各年 7,700行前後

---

## 2. 外交データ（Diplomacy）

### 📈 データ品質
```
初期行数: 433,552
最終行数: 43,650 ✓
保持率: 10.07%
除外率: 89.93% (主に年フィルタリング)
```

### ✅ 良好な点
- **年フィルタリング成功**: 5年分のみに絞り込み（89.83%除外は正常）
- **強い外交関係のみ抽出**: embassy_level >= 4
- **自己ループなし**: 0件（正常）

### ⚠️ 注意点
- **エンコーディング問題**: 4,429行（1.02%）
  - **影響**: 軽微（自動除外済み）
- **除外率が高い**: 89.93%
  - **理由**: 60年分のデータから5年分のみ抽出（正常）

### 📊 データ構造（予想）
```
year,origin,destination,embassy_level,focus
2000,USA,GBR,6,8
```

**年別データ量**: 各年 8,730行（43,650 / 5年）

---

## 3. 航空データ（Aviation）

### 📈 データ品質
```
初期路線数: 67,663
最終国ペア数: 4,301 ✓
最終路線数: 34,074
路線保持率: 50.36%
```

### ✅ 良好な点
- **国ペア数が十分**: 4,301ペア
- **ISO変換成功率**: 98.79%（失敗1.21%）
- **適切な集約**: 空港→国レベルへの変換成功

### ⚠️ 注意点
- **路線保持率**: 50.36%（国内路線47.35%除外は正常）
- **ISO変換失敗**: 23カ国
  - 主な失敗: Gambia, Guinea-Bissau, South Sudan など
  - **影響**: 軽微
- **スナップショットの複製**: 2014年データを5年分に複製
  - **制約**: 時系列変化を反映できない

### 📊 データ構造
```
year,origin,destination,route_count
2000,USA,CAN,215
2005,USA,CAN,215  ← 同じ値
```

**年別データ量**: 各年 4,301行（全年同一）

---

## 4. 貿易データ（Trade）

### 📈 データ品質
```
初期行数: 1,151,772
最終行数: 144,463 ✓
保持率: 12.54%
国数: 227
```

### ✅ 良好な点
- **十分なデータ量**: 144,463行（> 100,000行の基準をクリア）
- **欠損値なし**: 0%
- **年別データの安定性**: 各年24,000-31,000行

### 📊 年別データ量
```
2000: 24,655行
2005: 28,339行
2010: 30,752行
2015: 31,661行
2020: 29,056行
```

### 💰 貿易額統計（USD）
```
最小値: $1.00
最大値: $437,922,023,875 (中国→米国, 2020)
平均値: $442,850,593.81
中央値: $1,567,645.00
```

### 🌍 トップ10貿易回廊（2020年）
```
1. CHN → USA: $437.9B
2. MEX → USA: $321.0B
3. CAN → USA: $264.3B
4. CHN → HKG: $258.5B
5. USA → CAN: $223.2B
```

### ⚠️ 注意点
- **年カバレッジ**: 5/21年（5年ごとに制限）
  - **状態**: 正常（設計通り）

---

## 🔍 レイヤー間の比較

### データ量の比較（年あたり平均）

| レイヤー | 年平均行数 | 相対比率 |
|---------|-----------|---------|
| 移住 | 7,706 | 1.0x |
| 外交 | 8,730 | 1.1x |
| 航空 | 4,301 | 0.6x |
| 貿易 | 28,893 | 3.7x |

**観察**: 貿易データが最も密（3.7倍）、航空データが最も疎（0.6倍）

### 国カバレッジの推定

```
移住: ~200カ国（推定）
外交: ~200カ国（推定）
航空: ~180カ国（ISO変換成功）
貿易: 227カ国（明示）
```

**統合後の期待国数**: 200-227カ国

---

## 📋 データ統合への影響

### 統合時の予想

#### 年別エッジ数（outer join）

```python
# 理論的最大値（すべてのレイヤーを統合）
max_edges = max(7706, 8730, 4301, 28893) = 28,893/年

# 実際の統合エッジ数（outer join）
実際 ≈ 30,000-35,000/年（重複あり）

# 5年分の合計
総エッジ数 ≈ 150,000-175,000
```

#### データ存在率（2020年推定）

| レイヤー | エッジ数 | カバレッジ |
|---------|---------|-----------|
| 移住 | 7,995 | 57.1% |
| 外交 | 8,730 | ~62% |
| 航空 | 4,301 | ~31% |
| 貿易 | 29,056 | ~70% |

**NaN問題**: 各エッジで30-70%のレイヤーが欠損

---

## ⚠️ 潜在的な問題と対策

### 問題1: 航空データのスナップショット複製

**問題**:
- 2014年のデータを全年に複製
- 時系列変化が反映されない

**影響**:
- 中程度（航空ネットワークは比較的安定）
- Top-k予測への影響は限定的

**対策**:
- 分析時にこの制約を明記
- 結果解釈時に考慮

### 問題2: ISO変換失敗

**失敗国の例**:
- 移住: Gibraltar, Greenland, Puerto Rico（40カ国、22%）
- 外交: 軽微
- 航空: Gambia, South Sudan（23カ国、1.2%）
- 貿易: 軽微

**影響**:
- 軽微（主に属領・小国）
- 主要国は変換成功

**対策**:
- 現時点では対策不要
- 必要に応じてマッピング辞書を拡張

### 問題3: データ疎密のバラツキ

**観察**:
- 貿易データが非常に密（28,893行/年）
- 航空データが疎（4,301行/年）

**影響**:
- 多層ネットワークで重み付けが偏る可能性
- 均等重み（1/N）では貿易の影響が過大評価される可能性

**対策**:
- まず均等重みで実装（計画通り）
- 必要に応じて正規化を検討

---

## ✅ 前処理完了の確認

### チェックリスト

- [x] 移住データ: 38,530行、5年分
- [x] 外交データ: 43,650行、5年分
- [x] 航空データ: 4,301国ペア×5年 = 21,505行
- [x] 貿易データ: 144,463行、5年分
- [x] 品質レポート: すべて生成済み
- [x] ISO3コード形式: すべて統一
- [x] 自己ループ除去: すべて完了
- [x] 年範囲統一: 2000, 2005, 2010, 2015, 2020

**結論**: ✅ すべての前処理が正常に完了し、Top-k Accuracy検証に進む準備が整いました。

---

## 🚀 次のステップ

### ステップ1: データ統合スクリプトの確認

既存の`integrate_multilayer_network.py`を確認し、以下が実装されているか確認：
- 4レイヤーの読み込み
- outer joinでの統合
- カラム名の統一（diplomatic_relation, aviation_routes, trade_value）

### ステップ2: Top-k Accuracy検証スクリプトの実装

新規作成が必要：`topk_accuracy_validation.py`

実装内容:
1. 訓練データ（2000-2015）とテストデータ（2020）の分割
2. 8通りのレイヤー組み合わせ
3. 各組み合わせで中心性計算
4. Top-20予測と評価
5. 結果の可視化

### ステップ3: 既存スクリプトの活用

確認が必要:
- `network_centrality_analysis.py`: 中心性計算のロジック
- `centrality_detailed_analysis.py`: 詳細分析のロジック

これらを`topk_accuracy_validation.py`で再利用できるか検討。

---

## 📊 期待される最終結果

### 予想される精度範囲

```
移住のみ: 0.60-0.70 (12-14/20)
移住+外交: 0.70-0.80 (14-16/20)
移住+航空: 0.65-0.75 (13-15/20)
移住+貿易: 0.75-0.85 (15-17/20)
全レイヤー: 0.80-0.90 (16-18/20)
```

**仮説検証**: 多層ネットワークの精度 > 単層ネットワークの精度

---

**このレポートのバージョン**: 1.0  
**次のアクション**: 既存の分析スクリプトを確認し、Top-k検証スクリプトの実装方針を決定